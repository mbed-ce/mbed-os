#
# Copyright (c) 2025 Jamie Smith
# SPDX-License-Identifier: Apache-2.0
#

"""
Pydantic schemas for Mbed OS JSON config files.
"""

from __future__ import annotations

from typing import Union, Self, Literal

from pydantic import BaseModel, Field, model_validator

ConfigSettingValue = Union[int | float | bool | str | None]


class ConfigEntryDetails(BaseModel):
    """
    Details for an entry in a JSON file's 'config' section. This defines the attributes of a configurable setting
    for a library, target, or application.
    """

    macro_name: str | None = None
    """
    Name of the macro that this setting shall generate. If unset, defaults to 
    'MBED_CONF_<namespace uppercase>_<config entry name uppercase>'
    """

    value: ConfigSettingValue = None
    """ Default value for this setting when not overridden. """

    help: str | None = None
    """ Documentation associated with this setting. """

    accepted_values: list[ConfigSettingValue] | None = None
    """ 
    Enumeration of legal values for this setting. A warning will be issued if the setting is set to
    a value not in this list. 
    """

    value_max: int | float | None = None
    """
    For integer or floating point values, this gives the maximum allowed value.
    """

    value_min: int | float | None = None
    """
    For integer or floating point values, this gives the minimum allowed value.
    """

    @model_validator(mode="after")
    def verify_max_min(self) -> Self:
        if self.accepted_values is not None and (self.value_max is not None or self.value_min is not None):
            raise ValueError("May not specify both 'accepted_values' and 'value_min'/'value_max' at the same time!")

        if self.value_max is not None and self.value_min is not None:
            if self.value_max < self.value_min:
                raise ValueError("value_max cannot be less than value_min!")

        return self


class BaseJSONConfig(BaseModel):
    """
    Base schema for JSON config files. This schema applies to mbed_app.json5 and mbed_lib.json5,
    as well as each entry in targets.json5
    """

    config: dict[str, ConfigSettingValue | ConfigEntryDetails] = Field(default_factory=dict)
    """
    Configuration items for this library. These can be defined directly as "name": default value, or as
    "name": {details...} (see _ConfigEntryDetails above). Using details is recommended as it allows
    adding documentation for the setting.
    
    By convention, the name used for a configuration setting should be in skewer-case and should not contain
    periods, underscores, or uppercase letters.
    
    In target JSON, this is a merging attribute.
    """

    macros: list[str] | None = None
    """
    List of macros to unconditionally define when this lib is included, in "NAME" or "NAME=VALUE" format.
    
    In target JSON, this is an accumulating attribute.
    """

    overrides: dict[str, ConfigSettingValue] = Field(default_factory=dict)
    """
    List of overrides to unconditionally apply when this lib is included.
    
    Overrides take the form "[<namespace>.]<setting>": <value> and cause the value of the given config
    setting to be changed to the given value. If the namespace is omitted, it will be set to the current
    namespace.
    
    Note that in mbed_lib.json files, only settings defined in the current file or in the 'app' namespace
    (mbed_app.json) can be overridden.
    
    Override priority is defined as first mbed_app.json5, then mbed_lib.json5 files, then targets.json5.
    So, for example, an override defined in mbed_app.json5 supersedes any other overrides of that
    same setting.
    
    Override order between different mbed_lib.json5 files is not currently defined but should not matter
    because they cannot override settings from targets.json5 or other mbed_lib.json5 files.
    
    In target JSON, this is a merging attribute.
    """


class MbedLibJSON(BaseJSONConfig):
    """
    Schema for an mbed_lib.json5 config file.
    This type of config file provides information about a library (inside or outside the Mbed OS source tree)
    to the Mbed configuration system.
    """

    name: str
    """
    The name of this library. This is also considered the 'namespace' and will be prepended to all
    configuration settings generated by this file.
    """

    target_overrides: dict[str, dict[str, ConfigSettingValue]] = Field(default_factory=dict)
    """
    List of overrides applied based on target labels. This is similar to the "overrides" section,
    but allows applying the override only if the target has a specific label. Labels generally
    come from the names of the target and its parents, but targets can also add extra ones.
    For example:
    
    "target_overrides": {
        "MIMXRT105X": {
            "some-setting": some-value
        }
    }
    
    would apply the override only for targets in the MIMXRT105X target family.
    
    The magic target label "*" is always true and is equivalent to using the "overrides" section.
    
    Also note that the override priority between different sections within target_overrides, and between 
    target_overrides and overrides, is not currently defined. So, if you override the same setting in both,
    results may not be what you expect.
    """


class TargetJSON(BaseJSONConfig):
    """
    Schema for one entry in targets.json5.
    """

    inherits: list[str] = Field(default_factory=list)
    """
    Parent target(s) to inherit this target's attributes from.
    
    Multiple parent targets are allowed, but be careful as the inheritance tree is flattened into a list before 
    being processed, which can cause some possibly unexpected behavior. See below for more details.
    
    In the Mbed target configuration language, each attribute has one of three behaviors with respect to inheritance:
    "overriding", "merging", and "accumulating".

    Overriding attributes are the simplest, and work like regular inheritance in programming: the value of the attribute
    from the "closest" ancestor is used, and all other values are discarded.
    
    To determine the attribute's value, the inheritance tree is flattened into a list using a depth-first traversal
    that visits the first parent of each target first. For example, the inheritance tree diagram for target "A" below:

    D     E
    |     |
    B     C
    |_____|
       |
       A

    Would give us an inheritance order of [A, B, D, C, E]. Then, the overriding attribute's value would be taken
    from the first target in this list to contain the attribute.

    Merging attributes work similarly but are all of dict type. With merging attributes, the dicts are merged
    together with only elements with the same keys overriding based on the order above.
    
    Accumulating attributes, on the other hand, work very differently. These are all of list type, and have
    three forms: "<attribute>", "<attribute>_add", and "<attribute>_remove". Using the first of those forms (the base form)
    gives the attribute its initial value, and the second and third forms remove the attribute from parent targets.
    
    UNLIKE overriding and merging attributes, accumulating attributes use a breadth-first search to flatten
    the inheritance hierarchy. (why? no idea! -Jamie).  For example, an inheritance tree diagram for the target "A" below

    D     E
    |     |
    B     C
    |_____|
       |
       A

    Would give us an inheritance order of [A, B, C, D, E]. To process this, the first occurance of the bare
    attribute name in the above list is found, and then we work backwards towards target A processing "_add" and
    "_remove" directives until the full set of values is built up.
    
    *note:* Based on my current understanding of this code, if no parent target defines the attribute in base form,
    then the child targets cannot add to the value using "_add" - the config system will simply treat the attribute as
    not existing. This seems like a potential source of bugs, but I don't want to change it for fear of
    breaking something. -Jamie
    """

    public: bool = True
    """
    Whether this target is intended for user use and can be passed as a target when building Mbed.
    Set this to false for targets that are incomplete and intended to be inherited from other targets.
    
    This attribute is not affected by inheritance and always defaults to true unless set to false for
    each individual target.
    """

    core: str | None = None
    """
    Name of the CPU core used by this target. This gets set into the MBED_CPU_CORE CMake variable and
    is used to select the correct compile flags.
    
    This is an overriding attribute.
    """

    supported_form_factors: list[Literal["ARDUINO_UNO", "PMOD", "STMOD"]]
    """
    Form factors that this board supports.
    Form factors provide a standard electrical interface with standardized pin locations and functions for
    add-on boards. Enabling a form factor enables its standard pin names.
    See https://web.archive.org/web/20240620001521/https://os.mbed.com/docs/mbed-os/v6.16/porting/standard-pin-names.html
    
    This is an overriding attribute.
    """

    macros_add: list[str] = Field(default_factory=list)
    """
    Macros to add (see "macros"). 
    Using this attribute adds macros to the set defined by parent target(s), rather than overwriting it.
    
    This is a merging attribute in its add form.
    """

    macros_remove: list[str] = Field(default_factory=list)
    """
    Macros to remove (see "macros"). 
    Using this attribute removes macros from the set defined by parent target(s), rather than overwriting it.
    
    This is a merging attribute in its remove form.

    Note that this specific attribute has some special behavior, in that the value after the "=" in the macro
    definition can be ignored when finding matches to remove. So if the parent target adds a macro "FOO=7", then
    doing "macros_remove": ["FOO"] in a child target is enough to remove it.
    """

    extra_labels: list[str] = Field(default_factory=list)
    """
    Additional labels to add for this target and targets that inherit from it.
    Labels are added to the `MBED_TARGET_LABELS` list in CMake, and become compile definitions
    in the format `TARGET_<label>`.
    They are also used to control which directories in the source code are scanned for mbed_lib.json5 files.
    
    This is a merging attribute in its base form.
    """

    extra_labels_add: list[str] = Field(default_factory=list)
    """
    Labels to add (see "extra_labels"). 
    Using this attribute adds labels to the set defined by parent target(s), rather than overwriting it.
    
    This is a merging attribute in its add form.
    """

    extra_labels_remove: list[str] = Field(default_factory=list)
    """
    Labels to remove (see "extra_labels"). 
    Using this attribute removes labels from the set defined by parent target(s), rather than overwriting it.
    
    This is a merging attribute in its remove form.
    """

    components: list[str] = Field(default_factory=list)
    """
    Components to add for this target and targets that inherit from it.
    The components listed in the target's JSON give the hardware components that exist on the target
    board, such as SD cards, SPI flashes, bluetooth modules, etc. If a component is listed here, it should
    also have configuration in the relevant mbed_lib.json5 file so that it works out of the box with this
    target board.
    
    See mbed-os/targets/drivers.json5 for a full list of available components..
     
    The component list becomes compile definitions in the format `COMPONENT_<name>`.
    It is also used to control which directories in the source code are scanned for mbed_lib.json5 files.
    
    This is a merging attribute in its base form.
    """

    components_add: list[str] = Field(default_factory=list)
    """
    Components to add (see "components"). 
    Using this attribute adds components to the set defined by parent target(s), rather than overwriting it.
    
    This is a merging attribute in its add form.
    """

    components_remove: list[str] = Field(default_factory=list)
    """
    Components to remove (see "components"). 
    Using this attribute removes components from the set defined by parent target(s), rather than overwriting it.
    
    This is a merging attribute in its remove form.
    """

    features: list[str] = Field(default_factory=list)
    """
    Features to add for this target and targets that inherit from it.
    The features listed in the target's JSON give larger Mbed OS optional features that are supported for this target,
    such as bluetooth and security functionality.
    
    See mbed-os/targets/drivers.json5 for a full list of available features.
     
    The feature list becomes compile definitions in the format `FEATURE_<name>`.
    It is also used to control which directories in the source code are scanned for mbed_lib.json5 files.
    
    This is a merging attribute in its base form.
    """

    features_add: list[str] = Field(default_factory=list)
    """
    Features to add (see "features"). 
    Using this attribute adds features to the set defined by parent target(s), rather than overwriting it.
    
    This is a merging attribute in its add form.
    """

    features_remove: list[str] = Field(default_factory=list)
    """
    Features to remove (see "features"). 
    Using this attribute removes features from the set defined by parent target(s), rather than overwriting it.
    
    This is a merging attribute in its remove form.
    """

    device_has: list[str] = Field(default_factory=list)
    """
    Peripherals that this MCU has, such as I2C, Ethernet, real-time clock, etc. This tells Mbed which high-level
    APIs to make available for this target.
    
    See mbed-os/targets/drivers.json5 for a full list of recognized peripheral names.
     
    The peripheral list becomes compile definitions in the format `DEVICE_<name>`.
    
    This is a merging attribute in its base form.
    """

    device_has_add: list[str] = Field(default_factory=list)
    """
    Peripherals to add (see "device_has"). 
    Using this attribute adds peripherals to the set defined by parent target(s), rather than overwriting it.
    
    This is a merging attribute in its add form.
    """

    device_has_remove: list[str] = Field(default_factory=list)
    """
    Peripherals to remove (see "device_has"). 
    Using this attribute removes peripherals from the set defined by parent target(s), rather than overwriting it.
    
    This is a merging attribute in its remove form.
    """
