#
# Copyright (c) 2025 Jamie Smith
# SPDX-License-Identifier: Apache-2.0
#

"""
Pydantic schemas for Mbed OS JSON config files.
"""

from __future__ import annotations

from typing import Self, Union

from pydantic import BaseModel, Field, model_validator

ConfigSettingValue = Union[int | float | bool | str | None]


class ConfigEntryDetails(BaseModel):
    """
    Details for an entry in a JSON file's 'config' section. This defines the attributes of a configurable setting
    for a library, target, or application.
    """

    macro_name: str | None = None
    """
    Name of the macro that this setting shall generate. If unset, defaults to 
    'MBED_CONF_<namespace uppercase>_<config entry name uppercase>'
    """

    value: ConfigSettingValue = None
    """ Default value for this setting when not overridden. """

    help: str | None = None
    """ Documentation associated with this setting. """

    accepted_values: list[ConfigSettingValue] | None = None
    """ 
    Enumeration of legal values for this setting. A warning will be issued if the setting is set to
    a value not in this list. 
    """

    value_max: int | float | None = None
    """
    For integer or floating point values, this gives the maximum allowed value.
    """

    value_min: int | float | None = None
    """
    For integer or floating point values, this gives the minimum allowed value.
    """

    @model_validator(mode="after")
    def verify_max_min(self) -> Self:
        if self.accepted_values is not None and (self.value_max is not None or self.value_min is not None):
            raise ValueError("May not specify both 'accepted_values' and 'value_min'/'value_max' at the same time!")

        if self.value_max is not None and self.value_min is not None:
            if self.value_max < self.value_min:
                raise ValueError("value_max cannot be less than value_min!")

        return self


class MbedLibJSON(BaseModel):
    """
    Schema for an mbed_lib.json5 config file.
    This type of config file provides information about a library (inside or outside the Mbed OS source tree)
    to the Mbed configuration system.
    """

    name: str
    """
    The name of this library. This is also considered the 'namespace' and will be prepended to all
    configuration settings generated by this file.
    """

    config: dict[str, ConfigSettingValue | ConfigEntryDetails] = Field(default_factory=dict)
    """
    Configuration items for this library. These can be defined directly as "name": default value, or as
    "name": {details...} (see _ConfigEntryDetails above). Using details is recommended as it allows
    adding documentation for the setting.
    
    By convention, the name used for a configuration setting should be in skewer-case and should not contain
    periods, underscores, or uppercase letters.
    """

    macros: list[str] | None = None
    """
    List of macros to unconditionally define when this lib is included, in "NAME" or "NAME=VALUE" format.
    """

    overrides: dict[str, ConfigSettingValue] = Field(default_factory=dict)
    """
    List of overrides to unconditionally apply when this lib is included.
    
    Overrides take the form "[<namespace>.]<setting>": <value> and cause the value of the given config
    setting to be changed to the given value. If the namespace is omitted, it will be set to the current
    namespace.
    
    Note that in mbed_lib.json files, only settings defined in the current file or in the 'app' namespace
    (mbed_app.json) can be overridden.
    
    Override priority is defined as first mbed_app.json5, then mbed_lib.json5 files, then targets.json5.
    So, for example, an override defined in mbed_app.json5 supersedes any other overrides of that
    same setting.
    
    Override order between different mbed_lib.json5 files is not currently defined but should not matter
    because they cannot override settings from targets.json5 or other mbed_lib.json5 files.
    """

    target_overrides: dict[str, dict[str, ConfigSettingValue]] = Field(default_factory=dict)
    """
    List of overrides applied based on target labels. This is similar to the "overrides" section,
    but allows applying the override only if the target has a specific label. Labels generally
    come from the names of the target and its parents, but targets can also add extra ones.
    For example:
    
    "target_overrides": {
        "MIMXRT105X": {
            "some-setting": some-value
        }
    }
    
    would apply the override only for targets in the MIMXRT105X target family.
    
    The magic target label "*" is always true and is equivalent to using the "overrides" section.
    
    Also note that the override priority between different sections within target_overrides, and between 
    target_overrides and overrides, is not currently defined. So, if you override the same setting in both,
    results may not be what you expect.
    """
